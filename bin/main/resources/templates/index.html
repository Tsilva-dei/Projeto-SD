<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
    <title>Googol Search</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
        .search-box{ margin: 50px 0; }
        input[type="text"] { padding: 10px; width: 300px; }
        button { padding: 10px 20px; cursor: pointer; }
        .stats { margin-top: 50px; border-top: 1px solid #ccc; padding-top: 20px; text-align: center; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Googol</h1>

    <div th:if="${error}" class="error" th:text="${error}"></div>
    <div th:if="${message}" class="success" th:text="${message}"></div>

    <div class="search-box">
        <form action="/search" method="get">
            <input type="text" name="q" placeholder="Pesquisar..." required>
            <button type="submit">Pesquisar</button>
        </form>
    </div>
    <div class="index-box">
        <h3>Adicionar URL</h3>
        <form action="/index" method="post" style="margin-bottom: 15px;">
            <input type="text" name="url" placeholder="http://" required>
            <button type="submit">Indexar</button>
        </form>

        <form action="/index/hackernews" method="post">
            <button type="sumbit" style="background-color: #ff6600; color: white">
                Indexar Top Stories (HackerNews)
            </button>
        </form>
    </div>

    <div class="stats" id="statsContainer">
        <h3>Estatísticas em tempo real (WebSocket)</h3>

        <div style="display: flex; justify-content: space-around; text-align: left;">
            <div>
                <h4>Top pesquisas</h4>
                <ul id="topSearchesList">
                    <li>A carregar...</li>
                </ul>
            </div>
            <div>
                <h4>Barrels ativos</h4>
                <ul id="barrelsStatsList">
                    <li>A carregar...</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
        var stompClient = null;

        function connect() {
            // Liga ao endpoint que definimos no Java
            var socket = new SockJS('/googol-websocket');
            stompClient = Stomp.over(socket);
            
            // Desliga logs de debug da consola para não poluir
            stompClient.debug = null; 

            stompClient.connect({}, function (frame) {
                console.log('Ligado ao WebSocket!');
                
                // Subscreve o tópico onde o Java manda as stats
                stompClient.subscribe('/topic/stats', function (message) {
                    var stats = JSON.parse(message.body);
                    updateStatsUI(stats);
                });
            });
        }

        function updateStatsUI (stats) {
            // Atualizar top pesquisas
            var searchList = document.getElementById("topSearchesList");
            searchList.innerHTML = ""; // Limpa a lista

            if (stats.topSearches) {
                for (var term in stats.topSearches){
                    var count = stats.topSearches[term];
                    var li = document.createElement("li");
                    li.innerText = term + " (" + count + ")";
                    searchList.appendChild(li);
                }
            }
        
            // Atualizar barrels
            var barrelsList = document.getElementById("barrelsStatsList");
            barrelsList.innerHTML = ""; // Limpa a lista

            if (stats.barrelStats) {
                stats.barrelStats.forEach(function(barrel) {
                    var li = document.createElement("li");
                    li.innerText = "Barrel" + barrel.barrelId + ": " + barrel.indexSize + " págs | " + barrel.avgSearchTime + "ms média";
                    barrelsList.appendChild(li);
                });
            }
        }

        window.onload = connect;
    </script>
</body>
</html>